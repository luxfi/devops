apiVersion: apps/v1
kind: Deployment
metadata:
  name: blockscout-backend-{{ .Values.network }}
  namespace: lux-explorer
  labels:
    app: blockscout-backend
    network: {{ .Values.network }}
spec:
  replicas: {{ .Values.backend.replicas }}
  selector:
    matchLabels:
      app: blockscout-backend
      network: {{ .Values.network }}
  template:
    metadata:
      labels:
        app: blockscout-backend
        network: {{ .Values.network }}
    spec:
      containers:
        - name: backend
          image: {{ .Values.images.backend }}
          imagePullPolicy: Always
          command: ["sh", "-c", "bin/blockscout eval 'Explorer.ReleaseTasks.create_and_migrate()' && bin/blockscout start"]
          ports:
            - name: http
              containerPort: 4000
          env:
            - name: PORT
              value: "4000"
            - name: ETHEREUM_JSONRPC_VARIANT
              value: geth
            - name: ETHEREUM_JSONRPC_HTTP_URL
              value: {{ .Values.rpcUrl }}
            - name: ETHEREUM_JSONRPC_TRACE_URL
              value: {{ .Values.rpcUrl }}
            - name: ETHEREUM_JSONRPC_WS_URL
              value: {{ .Values.wsUrl }}
            - name: CHAIN_ID
              value: {{ .Values.chainId | quote }}
            - name: COIN
              value: {{ .Values.coinSymbol }}
            - name: COIN_NAME
              value: {{ .Values.coinName }}
            - name: DATABASE_URL
              value: "postgresql://blockscout:{{ .Values.postgres.password }}@blockscout-postgres-{{ .Values.network }}.lux-explorer.svc:5432/explorer_{{ .Values.network }}?sslmode=disable"
            - name: SECRET_KEY_BASE
              value: {{ .Values.backend.secretKeyBase }}
            - name: POOL_SIZE
              value: {{ .Values.backend.poolSize | quote }}
            - name: POOL_SIZE_API
              value: {{ .Values.backend.poolSizeApi | quote }}
            - name: ECTO_USE_SSL
              value: "false"
            - name: API_V2_ENABLED
              value: "true"
            - name: DISABLE_MARKET
              value: "true"
            - name: INDEXER_DISABLE_PENDING_TRANSACTIONS_FETCHER
              value: "true"
            - name: INDEXER_DISABLE_INTERNAL_TRANSACTIONS_FETCHER
              value: "true"
            - name: DISABLE_CATCHUP_INDEXER
              value: "false"
            - name: HEART_BEAT_TIMEOUT
              value: "30"
            - name: FIRST_BLOCK
              value: "0"
            - name: TXS_STATS_DAYS_TO_COMPILE_AT_INIT
              value: "10"
            - name: COIN_BALANCE_HISTORY_DAYS
              value: "90"
            - name: DISABLE_INDEXER
              value: "false"
            - name: DISABLE_REALTIME_INDEXER
              value: "false"
            - name: MICROSERVICE_VISUALIZE_SOL2UML_ENABLED
              value: "true"
            - name: MICROSERVICE_VISUALIZE_SOL2UML_URL
              value: "http://blockscout-visualizer-{{ .Values.network }}.lux-explorer.svc:8050/"
            - name: MICROSERVICE_SIG_PROVIDER_ENABLED
              value: "true"
            - name: MICROSERVICE_SIG_PROVIDER_URL
              value: "http://blockscout-sig-provider-{{ .Values.network }}.lux-explorer.svc:8050/"
          resources:
            {{- toYaml .Values.backend.resources | nindent 12 }}
          livenessProbe:
            httpGet:
              path: /api/v2/stats
              port: http
            initialDelaySeconds: 120
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 5
          readinessProbe:
            httpGet:
              path: /api/v2/stats
              port: http
            initialDelaySeconds: 60
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
---
apiVersion: v1
kind: Service
metadata:
  name: blockscout-backend-{{ .Values.network }}
  namespace: lux-explorer
  labels:
    app: blockscout-backend
    network: {{ .Values.network }}
spec:
  type: ClusterIP
  selector:
    app: blockscout-backend
    network: {{ .Values.network }}
  ports:
    - name: http
      port: 4000
      targetPort: 4000
