{{- $network := index .Values.networks .Values.network }}
{{- $namespace := $network.namespace }}
{{- $stakingPort := $network.stakingPort }}
{{- $httpPort := $network.httpPort }}
{{- $replicas := int .Values.replicas }}
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: luxd
  namespace: {{ $namespace }}
spec:
  serviceName: luxd-headless
  replicas: {{ .Values.replicas }}
  podManagementPolicy: Parallel
  updateStrategy:
    type: OnDelete
  selector:
    matchLabels:
      app: luxd
      lux-network: {{ .Values.network }}
  template:
    metadata:
      labels:
        app: luxd
        lux-network: {{ .Values.network }}
    spec:
      securityContext:
        fsGroup: 1000
        runAsUser: 1000
        runAsGroup: 1000
      terminationGracePeriodSeconds: 30
      {{- if .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml .Values.imagePullSecrets | nindent 8 }}
      {{- end }}
      initContainers:
      - name: init-plugins
        image: {{ .Values.image.repository }}:{{ .Values.image.tag }}
        imagePullPolicy: IfNotPresent
        securityContext:
          runAsUser: 0
          runAsGroup: 0
        command: ["/bin/sh", "-c"]
        args:
        - |
          set -e
          IDX=${HOSTNAME##*-}
          echo "=== Init for luxd-${IDX} ({{ .Values.network }}) ==="

          {{- if .Values.initMode.clearData }}
          echo "=== Clearing data for re-genesis (preserving RLP) ==="
          rm -rf /data/chainData /data/db /data/genesis.bytes
          echo "Data cleared"
          {{- else }}
          echo "=== Preserving existing data ==="
          {{- end }}

          # Set up plugins
          echo "=== Setting up plugins ==="
          mkdir -p /data/plugins
          # C-Chain EVM plugin
          cp /luxd/build/plugins/mgj786NP7uDwBCcq6YwThhaN8FLyybkCa4zBWTQbNgmK6k9A6 /data/plugins/
          # Subnet EVM plugin (same binary, different VM ID)
          cp /luxd/build/plugins/mgj786NP7uDwBCcq6YwThhaN8FLyybkCa4zBWTQbNgmK6k9A6 /data/plugins/ag3GReYPNuSR17rUP8acMdZipQBikdXNRKDyFszAysmy3vDXE

          # Set up staking keys
          echo "=== Setting up staking keys ==="
          mkdir -p /data/staking
          cp /staking-keys/staker-${IDX}.crt /data/staking/staker.crt
          cp /staking-keys/staker-${IDX}.key /data/staking/staker.key
          if [ -f "/staking-keys/signer-${IDX}.key" ]; then
            cp /staking-keys/signer-${IDX}.key /data/staking/signer.key
          fi
          chown -R 1000:1000 /data/staking
          chmod 600 /data/staking/*
          echo "=== Init complete ==="
        volumeMounts:
        - name: data
          mountPath: /data
        - name: staking-keys
          mountPath: /staking-keys
          readOnly: true
      containers:
      - name: luxd
        image: {{ .Values.image.repository }}:{{ .Values.image.tag }}
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        command: ["/bin/sh", "/scripts/startup.sh"]
        ports:
        - name: http
          containerPort: {{ $httpPort }}
        - name: staking
          containerPort: {{ $stakingPort }}
        livenessProbe:
          tcpSocket:
            port: {{ $httpPort }}
          initialDelaySeconds: 30
          periodSeconds: 10
          failureThreshold: 3
        readinessProbe:
          tcpSocket:
            port: {{ $httpPort }}
          initialDelaySeconds: 10
          periodSeconds: 5
          failureThreshold: 3
        resources:
          {{- toYaml .Values.resources | nindent 10 }}
        volumeMounts:
        - name: data
          mountPath: /data
        - name: genesis
          mountPath: /genesis
          readOnly: true
        - name: startup-script
          mountPath: /scripts
        - name: staking-keys
          mountPath: /staking-keys
          readOnly: true
      volumes:
      - name: genesis
        configMap:
          name: {{ .Values.genesis.configMapName }}
      - name: startup-script
        configMap:
          name: luxd-startup
          defaultMode: 0755
      - name: staking-keys
        secret:
          secretName: {{ .Values.staking.secretName }}
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: {{ .Values.storage.storageClass }}
      resources:
        requests:
          storage: {{ .Values.storage.size }}
